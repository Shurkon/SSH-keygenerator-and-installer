name: Test SSH Key Script

on:
  push:
    branches:
      - main
  workflow_dispatch:   # manual trigger
  schedule:
    - cron: "0 0 * * *"  # daily at 00:00 UTC

jobs:
  test-ssh-key:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Make script executable
        run: chmod +x ./ssh-addkey.sh

      - name: Run SSH key generation in dry mode
        run: |
          set -e

          TEST_KEY="test_ci_key"
          TEST_DIR=$(mktemp -d)
          export HOME="$TEST_DIR"

          # Create ~/.ssh in temporary HOME
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          # Run the SSH key script in a subshell with ssh disabled
          env SSH_COMMAND_SKIP=true bash -c '
            function ssh() { echo "Skipping SSH copy"; }
            export -f ssh
            printf "%s\n%s\n%s\n%s\n" "'"$TEST_KEY"'" "127.0.0.1" "ciuser" "22" | ./ssh-addkey.sh
          '

          # Verify keys exist
          if [[ ! -f "$HOME/.ssh/$TEST_KEY" ]]; then
            echo "Private key not created!"
            exit 1
          fi
          if [[ ! -f "$HOME/.ssh/$TEST_KEY.pub" ]]; then
            echo "Public key not created!"
            exit 1
          fi

          # Check public key format
          ssh-keygen -l -f "$HOME/.ssh/$TEST_KEY.pub"

          # Cleanup
          rm -rf "$TEST_DIR"


