name: Test SSH Key Script

on:
  push:
    branches:
      - main   # Se ejecuta en cada commit a main
  workflow_dispatch:   # Permite ejecuciÃ³n manual desde GitHub
  schedule:
    - cron: "0 0 * * *"  # Ejecuta diariamente a medianoche UTC

jobs:
  test-ssh-key:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Make script executable
        run: chmod +x ./ssh-addkey.sh

      - name: Run SSH key generation in dry mode
        run: |
          set -e

          TEST_KEY="test_ci_key"
          TEST_DIR=$(mktemp -d)
          export HOME="$TEST_DIR"

          # Create ~/.ssh in temporary HOME
          mkdir -p "$HOME/.ssh"
          chmod 700 "$HOME/.ssh"

          # Create a wrapper for ssh to skip real connection
          SSH_WRAPPER="$TEST_DIR/ssh_wrapper.sh"
          echo -e "#!/usr/bin/env bash\necho 'Skipping SSH copy'" > "$SSH_WRAPPER"
          chmod +x "$SSH_WRAPPER"
          export PATH="$TEST_DIR:$PATH"

          # Run the SSH key script non-interactively
          printf "%s\n%s\n%s\n%s\n" "$TEST_KEY" "127.0.0.1" "ciuser" "22" | ./ssh-addkey.sh

          # Check that the key files exist
          if [[ ! -f "$HOME/.ssh/$TEST_KEY" ]]; then
            echo "Private key not created!"
            exit 1
          fi
          if [[ ! -f "$HOME/.ssh/$TEST_KEY.pub" ]]; then
            echo "Public key not created!"
            exit 1
          fi

          # Validate the public key format
          ssh-keygen -l -f "$HOME/.ssh/$TEST_KEY.pub"
 
